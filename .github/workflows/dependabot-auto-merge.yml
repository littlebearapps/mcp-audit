# Dependabot Auto-Merge
# Auto-merges safe dependency updates after CI passes
#
# Security:
# - Only triggers for dependabot[bot] PRs
# - Checks PR author (user.login), not github.actor (security best practice)
# - Requires CI to pass before merge
# - Only auto-merges patch/minor for pip (major requires manual review)
# - Auto-merges all github-actions updates (low risk, easy rollback)

name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-Merge Dependabot PRs
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs - use user.login, NOT github.actor
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine auto-merge eligibility
        id: check
        env:
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type }}
          PACKAGE_ECOSYSTEM: ${{ steps.metadata.outputs.package-ecosystem }}
          DEPENDENCY_NAMES: ${{ steps.metadata.outputs.dependency-names }}
        run: |
          echo "Update type: $UPDATE_TYPE"
          echo "Ecosystem: $PACKAGE_ECOSYSTEM"
          echo "Dependencies: $DEPENDENCY_NAMES"

          # GitHub Actions - auto-merge ALL (including major)
          # Low risk: easy to revert, well-tested by community
          if [ "$PACKAGE_ECOSYSTEM" = "github_actions" ]; then
            echo "eligible=true" >> $GITHUB_OUTPUT
            echo "reason=GitHub Actions update - safe to auto-merge" >> $GITHUB_OUTPUT
            exit 0
          fi

          # pip dependencies - only patch and minor
          # Major updates may have breaking changes requiring manual review
          if [ "$PACKAGE_ECOSYSTEM" = "pip" ]; then
            if [ "$UPDATE_TYPE" = "version-update:semver-patch" ] || \
               [ "$UPDATE_TYPE" = "version-update:semver-minor" ]; then
              echo "eligible=true" >> $GITHUB_OUTPUT
              echo "reason=Patch/minor pip update - safe to auto-merge" >> $GITHUB_OUTPUT
            else
              echo "eligible=false" >> $GITHUB_OUTPUT
              echo "reason=Major pip update - requires manual review" >> $GITHUB_OUTPUT
            fi
          else
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=Unknown ecosystem - requires manual review" >> $GITHUB_OUTPUT
          fi

      - name: Wait for CI to pass
        if: steps.check.outputs.eligible == 'true'
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 20
          running-workflow-name: 'Auto-Merge Dependabot PRs'
          # Wait for all checks except this workflow and Supply Chain Scan
          # (Supply Chain Scan fails on Dependabot PRs due to missing secrets)
          check-regexp: '^(?!Auto-Merge Dependabot PRs|Supply Chain Scan).*$'

      - name: Enable auto-merge
        if: steps.check.outputs.eligible == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REASON: ${{ steps.check.outputs.reason }}
        run: |
          echo "::notice::Auto-merging PR: $REASON"
          gh pr merge --auto --squash "$PR_URL"

      - name: Log ineligible PRs
        if: steps.check.outputs.eligible == 'false'
        env:
          REASON: ${{ steps.check.outputs.reason }}
        run: |
          echo "::warning::PR not auto-merged: $REASON"
